import { Target, Settings, Gem, Map, Users, Globe, Brain, Shield, TrendingUp, Network, Code, ArrowUp, ChevronDown } from 'lucide-react';
import { useState, useEffect, memo } from 'react';
import type { Language, Page } from '../App';
import { whitepaperTranslations, whitepaperContent } from '../data/whitepaper-content';
import { formatContent } from '../utils/mdParser';

interface WhitepaperPageProps {
  language: Language;
  setCurrentPage: (page: Page) => void;
}

function WhitepaperPageComponent({ language, setCurrentPage }: WhitepaperPageProps) {
  const [activeSection, setActiveSection] = useState<number | null>(null);
  const [scrollProgress, setScrollProgress] = useState<number>(0);
  const [showBackToTop, setShowBackToTop] = useState<boolean>(false);
  const [expandedSection, setExpandedSection] = useState<number | null>(null);
  const t = whitepaperTranslations[language];
  const content = whitepaperContent[language as keyof typeof whitepaperContent] || whitepaperContent.en;

  useEffect(() => {
    const handleScroll = () => {
      const windowHeight = window.innerHeight;
      const documentHeight = document.documentElement.scrollHeight - windowHeight;
      const scrolled = window.scrollY;
      const progress = (scrolled / documentHeight) * 100;
      setScrollProgress(progress);
      setShowBackToTop(scrolled > 500);

      const sections = content.sections;
      for (let i = sections.length - 1; i >= 0; i--) {
        const element = document.getElementById(`section-${sections[i].id}`);
        if (element) {
          const rect = element.getBoundingClientRect();
          if (rect.top <= 150) {
            setActiveSection(sections[i].id);
            break;
          }
        }
      }
    };

    window.addEventListener('scroll', handleScroll);
    return () => window.removeEventListener('scroll', handleScroll);
  }, [content.sections]);

  useEffect(() => {
    window.scrollTo(0, 0);
  }, []);

  const scrollToSection = (sectionId: number) => {
    setExpandedSection(sectionId);
    setTimeout(() => {
      const element = document.getElementById(`section-${sectionId}`);
      if (element) {
        const offset = 100;
        const elementPosition = element.getBoundingClientRect().top;
        const offsetPosition = elementPosition + window.pageYOffset - offset;
        window.scrollTo({
          top: offsetPosition,
          behavior: 'smooth'
        });
      }
    }, 50);
  };

  const toggleSection = (sectionId: number) => {
    setExpandedSection(expandedSection === sectionId ? null : sectionId);
  };

  const scrollToTop = () => {
    window.scrollTo({
      top: 0,
      behavior: 'smooth'
    });
  };

  const renderIcon = (iconName: string, size: number = 24) => {
    const icons: Record<string, any> = {
      Globe,
      Brain,
      Network,
      Code,
      Settings,
      Gem,
      TrendingUp,
      Shield,
      Users,
      Map,
      Target
    };
    const IconComponent = icons[iconName];
    return IconComponent ? <IconComponent size={size} className="text-lime-400" /> : null;
  };

  return (
    <div className="min-h-screen bg-[#0a0a0a] relative">
      {/* Reading Progress Bar */}
      <div className="fixed top-0 left-0 right-0 h-1 bg-white/5 z-50">
        <div
          className="h-full bg-gradient-to-r from-lime-500 via-emerald-500 to-cyan-500 transition-all duration-300"
          style={{ width: `${scrollProgress}%` }}
        />
      </div>

      <div className="container mx-auto px-6 pb-32 relative z-10" style={{ paddingTop: '160px' }}>
        <div className="max-w-4xl mx-auto relative">
          {/* Header */}
          <div className="mb-16 text-center">
            <h1 className="text-5xl md:text-6xl font-bold text-white mb-6 tracking-tight leading-tight">
              {t.title}
            </h1>
            <p className="text-xl text-zinc-400 font-light max-w-2xl leading-relaxed mx-auto">
              {t.subtitle}
            </p>
          </div>

          {/* Table of Contents */}
          <aside className="mb-16 max-w-2xl mx-auto">
            <div className="border-l border-white/[0.08] pl-6 space-y-1">
              {content.sections.map((section) => (
                <button
                  key={section.id}
                  onClick={() => scrollToSection(section.id)}
                  className={`w-full text-left flex items-center gap-4 py-2 transition-all duration-200 relative ${
                    activeSection === section.id
                      ? 'text-white'
                      : 'text-zinc-500 hover:text-zinc-300'
                  }`}
                >
                  {activeSection === section.id && (
                    <div className="absolute -left-6 top-1/2 -translate-y-1/2 w-[2px] h-5 bg-lime-500 -ml-px" />
                  )}
                  <span className={`text-[13px] font-mono w-6 flex-shrink-0 ${
                    activeSection === section.id ? 'text-lime-400' : 'text-zinc-600'
                  }`}>
                    {String(section.id).padStart(2, '0')}
                  </span>
                  <span className="text-[15px]">{section.title}</span>
                </button>
              ))}
            </div>
          </aside>

          {/* Sections */}
          <div className="max-w-2xl mx-auto space-y-4">
              {content.sections.map((section, index) => (
                <div
                  key={section.id}
                  id={`section-${section.id}`}
                  className="scroll-mt-24 relative pl-6 border-l border-white/[0.08]"
                >
                  <button
                    onClick={() => toggleSection(section.id)}
                    className="w-full text-left flex items-center justify-between py-3 group"
                  >
                    <div className="flex items-center gap-4">
                      <span className={`text-[13px] font-mono flex-shrink-0 ${expandedSection === section.id ? 'text-lime-400' : 'text-zinc-600'}`}>
                        {String(section.id).padStart(2, '0')}
                      </span>
                      <h2 className={`text-lg font-semibold leading-tight transition-colors ${expandedSection === section.id ? 'text-lime-400' : 'text-zinc-400 group-hover:text-zinc-200'}`}>
                        {section.title}
                      </h2>
                    </div>
                    <ChevronDown
                      size={18}
                      className={`text-zinc-500 transition-transform duration-200 flex-shrink-0 ${expandedSection === section.id ? 'rotate-180' : ''}`}
                    />
                  </button>

                  {expandedSection === section.id && (
                    <div className="prose prose-invert max-w-none pb-6 pl-10">
                      <div 
                        className="text-zinc-300 leading-relaxed text-[15px]"
                        dangerouslySetInnerHTML={{
                          __html: formatContent(section.content)
                        }}
                      />
                          />
                        );
                      } else if (paragraph.trim().startsWith('**') && paragraph.trim().endsWith('**')) {
                        const text = paragraph.trim().slice(2, -2);
                        return (
                          <h3 key={pIdx} className="text-lg font-semibold text-white mt-8 mb-4">
                            {text}
                          </h3>
                        );
                      } else if (paragraph.trim().startsWith('|')) {
                        const rows = paragraph.trim().split('\n').filter(row => row.trim());
                        if (rows.length < 2) return null;

                        const headerCells = rows[0].split('|').slice(1, -1).map(c => c.trim());
                        const firstDataRow = rows.length > 2 ? rows[2].split('|').slice(1, -1).map(c => c.trim()) : [];
                        const isDataTable = firstDataRow.length > 0 && firstDataRow[0].length < 20;

                        return (
                          <div key={pIdx} className="overflow-x-auto my-6 mb-8 rounded-xl" style={{ backgroundColor: '#27272a' }}>
                            <table className="w-full border-collapse" style={{ tableLayout: 'auto' }}>
                              <thead>
                                <tr style={{ backgroundColor: '#3f3f46' }}>
                                  {headerCells.map((cell, idx) => (
                                    <th key={idx} className={`${isDataTable ? 'text-center' : 'text-left'} px-4 py-3 text-[11px] tracking-wide whitespace-normal`} style={{ color: '#ffffff', fontWeight: 'bold', lineHeight: '1.4' }}>
                                      {cell}
                                    </th>
                                  ))}
                                </tr>
                              </thead>
                              <tbody style={{ backgroundColor: '#27272a' }}>
                                {rows.slice(2).map((row, rIdx) => {
                                  const cells = row.split('|').slice(1, -1).map(c => c.trim());
                                  return (
                                    <tr key={rIdx} className="hover:bg-zinc-700 transition-all duration-200">
                                      {cells.map((cell, cIdx) => (
                                        <td
                                          key={cIdx}
                                          className={`${isDataTable ? 'text-center' : 'text-left'} px-4 py-3 text-[11px] whitespace-normal break-words`}
                                          style={{ color: cIdx === 0 ? '#f4f4f5' : '#d4d4d8', fontWeight: cIdx === 0 ? '500' : 'normal', lineHeight: '1.5' }}
                                          dangerouslySetInnerHTML={{
                                            __html: cell
                                              .replace(/\*\*(.*?)\*\*/g, '<strong style="color: #ffffff; font-weight: 600;">$1</strong>')
                                              .replace(/✓|✔/g, '<span style="color: #84cc16;">✓</span>')
                                              .replace(/✗|✘|×/g, '<span style="color: #ef4444;">✗</span>')
                                          }}
                                        />
                                      ))}
                                    </tr>
                                  );
                                })}
                              </tbody>
                            </table>
                          </div>
                        );
                      } else {
                        return (
                          <p
                            key={pIdx}
                            className="text-zinc-400 leading-relaxed mb-4 text-[15px]"
                            dangerouslySetInnerHTML={{
                              __html: paragraph
                                .replace(/\*\*(.*?)\*\*/g, '<strong class="text-white font-medium">$1</strong>')
                                .replace(/#YouTube#/g, '<span class="inline-block px-2 py-0.5 mx-1 text-[12px] rounded-md" style="background: rgba(239, 68, 68, 0.1); color: rgb(248, 113, 113); border: 0.5px solid rgb(248, 113, 113);">YouTube</span>')
                                .replace(/#Facebook#/g, '<span class="inline-block px-2 py-0.5 mx-1 text-[12px] rounded-md" style="background: rgba(59, 130, 246, 0.1); color: rgb(96, 165, 250); border: 0.5px solid rgb(96, 165, 250);">Facebook</span>')
                                .replace(/#微博#/g, '<span class="inline-block px-2 py-0.5 mx-1 text-[12px] rounded-md" style="background: rgba(249, 115, 22, 0.1); color: rgb(251, 146, 60); border: 0.5px solid rgb(251, 146, 60);">微博</span>')
                                .replace(/#门户网站#/g, '<span class="inline-block px-2 py-0.5 mx-1 text-[12px] rounded-md" style="background: rgba(168, 85, 247, 0.1); color: rgb(192, 132, 252); border: 0.5px solid rgb(192, 132, 252);">门户网站</span>')
                                .replace(/#BBS#/g, '<span class="inline-block px-2 py-0.5 mx-1 text-[12px] rounded-md" style="background: rgba(6, 182, 212, 0.1); color: rgb(34, 211, 238); border: 0.5px solid rgb(34, 211, 238);">BBS</span>')
                                .replace(/#早期博客#/g, '<span class="inline-block px-2 py-0.5 mx-1 text-[12px] rounded-md" style="background: rgba(236, 72, 153, 0.1); color: rgb(244, 114, 182); border: 0.5px solid rgb(244, 114, 182);">早期博客</span>')
                                .replace(/#([^#]+)#/g, '<span class="inline-block px-2 py-0.5 mx-1 text-[12px] rounded-md" style="background: rgba(132, 204, 22, 0.1); color: rgb(163, 230, 53); border: 0.5px solid rgb(163, 230, 53);">$1</span>')
                            }}
                          />
                        );
                      }
                    })}
                  </div>
                  )}
                </div>
              ))}
            </div>
        </div>
      </div>

      {/* Back to Top Button */}
      {showBackToTop && (
        <button
          onClick={scrollToTop}
          className="fixed bottom-8 right-8 w-12 h-12 bg-gradient-to-br from-lime-500 to-emerald-500 text-black rounded-full shadow-lg shadow-lime-500/25 hover:shadow-xl hover:shadow-lime-500/40 transition-all duration-300 hover:-translate-y-1 flex items-center justify-center z-40"
        >
          <ArrowUp size={20} />
        </button>
      )}
    </div>
  );
}

export const WhitepaperPage = memo(WhitepaperPageComponent);
